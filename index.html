<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>á€á¶ášá‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á á¶á„ (PWA)</title>
  <link href="https://fonts.googleapis.com/css2?family=Battambang&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#007bff" />
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">

  <style>
    :root{--primary:#007bff;--bg:#f8f9fa;--card:#fff;--text:#000}
    body{font-family:'Battambang',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:12px;transition:0.2s}
    body.dark{--bg:#121212;--card:#1e1e1e;--text:#f1f1f1}
    .wrap{max-width:700px;margin:8px auto}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);margin-bottom:12px}
    h2,h3{margin:6px 0 10px}
    input,select,button,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;box-sizing:border-box}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .small{padding:8px;font-size:14px}
    .btn-ghost{background:transparent;color:var(--primary);border:1px solid var(--primary)}
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(0,0,0,0.06)}
    img.icon{width:40px;height:40px;border-radius:6px;object-fit:cover;margin-left:8px}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="text-align:right;margin-bottom:8px">
      <button id="darkToggle" class="small">ğŸŒ™/â˜€ï¸ Dark Mode</button>
    </div>

    <!-- Login Card -->
    <div id="login" class="card">
      <h2>á…á¼á›á”áŸ’ášá–áŸá“áŸ’á’</h2>
      <input id="email" placeholder="á¢áŸŠá¸á˜áŸ‚á› (admin@store.com or seller@store.com)" />
      <input id="password" type="password" placeholder="á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹" />
      <div class="row">
        <button onclick="login()">á…á¼á›</button>
        <button class="btn-ghost" onclick="signupDemo()">á”á„áŸ’á€á¾á demo users</button>
      </div>
      <p style="font-size:13px;color:#666">Note: Use your Firebase project keys in the code. This demo keeps data in Firestore.</p>
    </div>

    <!-- Admin Card -->
    <div id="admin" class="card" style="display:none">
      <h2>á•áŸ’á‘á¶áŸ†á„á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„</h2>
      <div class="row">
        <button onclick="logout()">á…áŸá‰</button>
        <button onclick="toggleAdminPanel()">á”á„áŸ’á á¶á‰/á›á¶á€áŸ‹ á€á¶ášá‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á”áŸ’ášá—áŸá‘</button>
      </div>

      <!-- Category manager -->
      <div id="catManager" style="display:none;margin-top:10px">
        <h3>á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á”áŸ’ášá—áŸá‘ (Categories)</h3>
        <div class="row">
          <input id="newCategory" placeholder="áˆáŸ’á˜áŸ„áŸ‡á”áŸ’ášá—áŸá‘â€‹ááŸ’á˜á¸" />
          <button onclick="addCategory()">á”á“áŸ’ááŸ‚á˜</button>
        </div>
        <div id="categoriesList"></div>
      </div>

      <!-- Item form -->
      <h3>á”á“áŸ’ááŸ‚á˜/á€áŸ‚á‘áŸ†á“á·á‰</h3>
      <input id="itemName" placeholder="áˆáŸ’á˜áŸ„áŸ‡á‘áŸ†á“á·á‰" />
      <input id="itemSKU" placeholder="á€á¼áŠá‘áŸ†á“á·á‰ (optional)" />
      <input id="itemPrice" type="number" placeholder="áá˜áŸ’á›áŸƒ (áŸ›)" />
      <select id="itemCategorySelect"></select>
      <input id="itemImage" type="file" accept="image/*" />
      <input id="editItemId" type="hidden" />
      <div class="row">
        <button onclick="saveItem()">ášá€áŸ’áŸá¶á‘á»á€</button>
        <button class="btn-ghost" onclick="clearItemForm()">áŸáŸ’áœáŸ‚á„áŸá·á“</button>
      </div>

      <h3>á”á‰áŸ’á‡á¸á‘áŸ†á“á·á‰</h3>
      <div id="items"></div>

      <h3>ášá”á¶á™á€á¶ášááŸá›á€áŸ‹ (Admin)</h3>
      <div class="row">
        <button onclick="loadReport('day','admin')">ááŸ’á„áŸƒá“áŸáŸ‡</button>
        <button onclick="loadReport('week','admin')">áŸá”áŸ’áŠá¶á áŸ</button>
        <button onclick="loadReport('month','admin')">ááŸ‚</button>
      </div>
      <div style="margin-top:8px">
        <div class="row">
          <input type="date" id="startDate">
          <input type="date" id="endDate">
        </div>
        <div class="row">
          <button onclick="loadReport('custom','admin')">áŸáŸ’áœáŸ‚á„ášá€</button>
          <button onclick="clearReport('admin')" class="btn-ghost">á›á»á”ášá”á¶á™á€á¶ášááŸ</button>
        </div>
        <div class="row" style="margin-top:6px">
          <button onclick="downloadExcel()">áá¶á‰á™á€ Excel</button>
          <button onclick="downloadPDF()">áá¶á‰á™á€ PDF</button>
        </div>
      </div>
      <div id="adminReport"></div>
    </div>

    <!-- Seller Card -->
    <div id="seller" class="card" style="display:none">
      <h2>á•áŸ’á‘á¶áŸ†á„á¢áŸ’á“á€á›á€áŸ‹</h2>
      <div class="row">
        <button onclick="logout()">á…áŸá‰</button>
      </div>

      <h3>á‡áŸ’ášá¾áŸá”áŸ’ášá—áŸá‘</h3>
      <select id="sellCategory" onchange="loadSellItems()"></select>
      <h3>á‡áŸ’ášá¾áŸá‘áŸ†á“á·á‰</h3>
      <div id="sellItems"></div>
      <input id="sellQty" type="number" placeholder="á…áŸ†á“á½á“á›á€áŸ‹ (á§. 3)" />
      <button onclick="confirmSell()">á›á€áŸ‹</button>

      <h3>ášá”á¶á™á€á¶ášááŸá›á€áŸ‹ (Seller)</h3>
      <div class="row">
        <button onclick="loadReport('day','seller')">ááŸ’á„áŸƒá“áŸáŸ‡</button>
        <button onclick="loadReport('week','seller')">áŸá”áŸ’áŠá¶á áŸ</button>
        <button onclick="loadReport('month','seller')">ááŸ‚</button>
      </div>
      <div style="margin-top:8px">
        <div class="row">
          <input type="date" id="startDateSeller"><input type="date" id="endDateSeller">
        </div>
        <div class="row">
          <button onclick="loadReport('custom','seller')">áŸáŸ’áœáŸ‚á„ášá€</button>
          <button onclick="clearReport('seller')" class="btn-ghost">á›á»á”ášá”á¶á™á€á¶ášááŸ</button>
        </div>
        <div class="row" style="margin-top:6px">
          <button onclick="downloadExcel()">Excel</button>
          <button onclick="downloadPDF()">PDF</button>
        </div>
      </div>
      <div id="report"></div>
    </div>
  </div>

  <!-- Firebase + App Logic -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCL1WNujP_W_JBmFGGd7LkkVX3ZUg_3ar8",
  authDomain: "stock-store-890d2.firebaseapp.com",
  projectId: "stock-store-890d2",
  storageBucket: "stock-store-890d2.firebasestorage.app",
  messagingSenderId: "1023419430534",
  appId: "1:1023419430534:web:f13088ef89438326c18307"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // UI helpers
  const $ = id => document.getElementById(id);

  // Dark mode
  $('darkToggle').addEventListener('click',()=>{
    document.body.classList.toggle('dark');
    localStorage.setItem('darkMode', document.body.classList.contains('dark'));
  });
  if(localStorage.getItem('darkMode')==='true') document.body.classList.add('dark');

  // Auth state
  auth.onAuthStateChanged(user=>{
    if(user){
      if(user.email==='admin@store.com'){ $('admin').style.display='block'; $('seller').style.display='none'; $('login').style.display='none'; loadItems(); loadCategories(); }
      else { $('seller').style.display='block'; $('admin').style.display='none'; $('login').style.display='none'; loadCategories(); }
    } else { $('login').style.display='block'; $('admin').style.display='none'; $('seller').style.display='none'; }
  });

  // Demo user creation for testing (only creates users in Firebase Auth)
  async function signupDemo(){
    try{
      await auth.createUserWithEmailAndPassword('admin@store.com','admin123').catch(()=>{});
      await auth.createUserWithEmailAndPassword('seller@store.com','seller123').catch(()=>{});
      alert('Demo users created: admin@store.com/admin123 and seller@store.com/seller123');
    }catch(e){console.error(e); alert('Error creating demo users: '+e.message);}
  }

  async function login(){
    const email=$('email').value.trim(), pass=$('password').value.trim();
    if(!email||!pass){alert('á”á‰áŸ’á…á¼á›á¢áŸŠá¸á˜áŸ‚á› á“á·á„â€‹á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹');return;}
    try{
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInWithEmailAndPassword(email,pass);
    }catch(e){alert('á…á¼á›á”ášá¶á‡áŸá™: '+e.message)}
  }
  function logout(){ auth.signOut(); }

  // ----- Categories -----
  async function addCategory(){
    const name=$('newCategory').value.trim();
    if(!name) return alert('á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á”áŸ’ášá—áŸá‘');
    await db.collection('categories').add({name});
    $('newCategory').value=''; loadCategories(); alert('á”á¶á“á”á“áŸ’ááŸ‚á˜á”áŸ’ášá—áŸá‘');
  }

  async function loadCategories(){
    const snap=await db.collection('categories').get();
    const cats=snap.docs.map(d=>({id:d.id,...d.data()}));
    // Ensure categories list includes any categories from items too
    const itemsSnap = await db.collection('items').get();
    itemsSnap.docs.forEach(d=>{ const c=d.data().category; if(c && !cats.find(x=>x.name===c)) cats.push({id:null,name:c}); });

    $('sellCategory').innerHTML = cats.map(c=>`<option value="${c.name}">${c.name}</option>`).join('') || '<option>á‘á‘áŸ</option>';
    $('itemCategorySelect').innerHTML = '<option value="">-- á‡áŸ’ášá¾áŸá”áŸ’ášá—áŸá‘ --</option>' + cats.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
    renderCategoriesList(cats);
  }

  function renderCategoriesList(cats){
    $('categoriesList').innerHTML = cats.map(c=>`<div class="list-item"><div>${c.name}</div><div>
      <button onclick="editCategory('${c.id||''}','${c.name}')">á€áŸ‚</button>
      <button onclick="deleteCategory('${c.id||''}')">á›á»á”</button>
    </div></div>`).join('');
  }

  function editCategory(id,name){
    const newName = prompt('á€áŸ‚áˆáŸ’á˜áŸ„áŸ‡á”áŸ’ášá—áŸá‘:', name);
    if(!newName) return;
    if(id) db.collection('categories').doc(id).update({name:newName}).then(()=>loadCategories());
    else { alert('This category comes from items and cannot be edited here. To change, edit the item.'); }
  }

  async function deleteCategory(id){
    if(!id){ alert('Cannot delete category created from items. Edit items instead.'); return; }
    if(!confirm('á›á»á”á”áŸ’ášá—áŸá‘á“áŸáŸ‡?')) return;
    await db.collection('categories').doc(id).delete();
    loadCategories();
  }

  // ----- Items management -----
  async function saveItem(){
    const id=$('editItemId').value.trim();
    const name=$('itemName').value.trim();
    const sku=$('itemSKU').value.trim();
    const price=parseFloat($('itemPrice').value)||0;
    const category=$('itemCategorySelect').value;
    const file=$('itemImage').files[0];
    if(!name) return alert('á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á‘áŸ†á“á·á‰');

    let imageUrl='';
    if(file){
      const ref=storage.ref('items/'+Date.now()+'-'+file.name);
      await ref.put(file);
      imageUrl = await ref.getDownloadURL();
    }

    if(id){
      const data={name,sku,price,category};
      if(imageUrl) data.imageUrl=imageUrl;
      await db.collection('items').doc(id).update(data);
      alert('Item updated');
    } else {
      await db.collection('items').add({name,sku,price,category,imageUrl});
      alert('Item added');
    }
    clearItemForm(); loadItems(); loadCategories();
  }

  function clearItemForm(){['editItemId','itemName','itemSKU','itemPrice','itemImage'].forEach(id=>{ const el=$(id); if(el) el.value=''; }); $('itemCategorySelect').value=''; }

  async function loadItems(){
    const snap=await db.collection('items').get();
    const html = snap.docs.map(d=>{ const it=d.data(); return `<div class="list-item"><div><b>${it.name}</b> <div style="color:#666">${it.category||''} â€¢ ${it.price?.toLocaleString?.()||it.price} áŸ›</div></div><div>
      <button onclick="startEdit('${d.id}')">á€áŸ‚</button>
      <button onclick="deleteItem('${d.id}')">á›á»á”</button>
    </div></div>` }).join('');
    $('items').innerHTML = html || '<div>á‚áŸ’á˜á¶á“á‘áŸ†á“á·á‰</div>';
  }

  async function startEdit(id){
    const doc=await db.collection('items').doc(id).get();
    if(!doc.exists) return alert('Item not found');
    const it=doc.data();
    $('editItemId').value=id; $('itemName').value=it.name||''; $('itemSKU').value=it.sku||''; $('itemPrice').value=it.price||''; $('itemCategorySelect').value=it.category||'';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  async function deleteItem(id){
    if(!confirm('á›á»á”á‘áŸ†á“á·á‰?')) return;
    await db.collection('items').doc(id).delete();
    loadItems(); loadCategories();
  }

  // ----- Seller flow -----
  async function loadSellItems(){
    const cat = $('sellCategory').value;
    const snap = await db.collection('items').where('category','==',cat).get();
    if(snap.empty){ $('sellItems').innerHTML='<div>á‚áŸ’á˜á¶á“á‘áŸ†á“á·á‰</div>'; return; }
    $('sellItems').innerHTML = '<select id="sellItem">'+ snap.docs.map(d=>`<option value="${d.id}">${d.data().name} - ${d.data().price?.toLocaleString?.()||d.data().price} áŸ›</option>`).join('') +'</select>';
  }

  async function confirmSell(){
    const sel = $('sellItem'); if(!sel) return alert('á‡áŸ’ášá¾áŸá‘áŸ†á“á·á‰á˜á»á“');
    const itemId = sel.value; const qty = parseInt($('sellQty').value)||1;
    const itemDoc = await db.collection('items').doc(itemId).get(); if(!itemDoc.exists) return alert('Item missing');
    const item = itemDoc.data();
    await db.collection('sales').add({ itemId, qty, total: (item.price||0)*qty, timestamp: new Date() });
    alert('á›á€áŸ‹á”á¶á“á‡áŸ„á‚á‡áŸá™');
  }

  // ----- Reports -----
  let lastReportData = [];
  async function loadReport(period, from='seller'){
    let start = new Date(), end = new Date();
    if(period==='day') start.setHours(0,0,0,0);
    if(period==='week') start.setDate(start.getDate()-7);
    if(period==='month') start.setMonth(start.getMonth()-1);
    if(period==='all') start = new Date(0);
    if(period==='custom'){
      const s = (from==='seller')?$('startDateSeller').value:$('startDate').value;
      const e = (from==='seller')?$('endDateSeller').value:$('endDate').value;
      start = s? new Date(s): new Date(0);
      end = e? new Date(e): new Date();
      end.setHours(23,59,59,999);
    }
    let q = db.collection('sales').where('timestamp','>=',start);
    if(period==='custom') q = q.where('timestamp','<=',end);
    const snap = await q.orderBy('timestamp','desc').get();
    let total=0, grouped={};
    for(const doc of snap.docs){
      const sale = doc.data(); total += sale.total || 0;
      let name='á˜á·á“áŸáŸ’á‚á¶á›áŸ‹'; if(sale.itemId){ const it = await db.collection('items').doc(sale.itemId).get(); if(it.exists) name = it.data().name; }
      if(!grouped[name]) grouped[name]={qty:0,total:0,sales:[]};
      grouped[name].qty += sale.qty; grouped[name].total += sale.total; grouped[name].sales.push({date: sale.timestamp.toDate().toLocaleString('km-KH'), qty: sale.qty, total: sale.total});
    }
    let html=''; lastReportData = [];
    Object.keys(grouped).forEach(n=>{
      html += `<div class="card"><b>${n}</b><div>á…áŸ†á“á½á“áŸ– ${grouped[n].qty} â€¢ áá˜áŸ’á›áŸƒáŸášá»á”áŸ– ${grouped[n].total.toLocaleString()} áŸ›</div>`;
      grouped[n].sales.forEach(s=>{ html += `<div style="margin-left:12px">ğŸ—“ ${s.date} â€¢ á…áŸ†á“á½á“: ${s.qty} â€¢ ${s.total.toLocaleString()} áŸ›</div>`; lastReportData.push({á‘áŸ†á“á·á‰:n,á€á¶á›á”ášá·á…áŸ’á†áŸá‘:s.date,á…áŸ†á“á½á“:s.qty,áá˜áŸ’á›áŸƒ:s.total}); });
      html += `</div>`;
    });
    html += `<div style="font-weight:bold;margin-top:8px">áŸášá»á”: ${total.toLocaleString()} áŸ›</div>`;
    lastReportData.push({á‘áŸ†á“á·á‰:'áŸášá»á”',á€á¶á›á”ášá·á…áŸ’á†áŸá‘:'',á…áŸ†á“á½á“:'',áá˜áŸ’á›áŸƒ:total});
    $(from==='seller'?'report':'adminReport').innerHTML = html;
  }
  function clearReport(from){ lastReportData=[]; $(from==='seller'?'report':'adminReport').innerHTML=''; }

  // ----- Export -----
  function downloadExcel(){
    if(!lastReportData.length) return alert('á‚áŸ’á˜á¶á“á‘á·á“áŸ’á“á“áŸá™');
    const ws = XLSX.utils.json_to_sheet(lastReportData);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Report');
    XLSX.writeFile(wb,'report.xlsx');
  }
  function downloadPDF(){
    if(!lastReportData.length) return alert('á‚áŸ’á˜á¶á“á‘á·á“áŸ’á“á“áŸá™');
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    doc.text('ášá”á¶á™á€á¶ášááŸá›á€áŸ‹',14,20);
    const body = lastReportData.map(r=>[r['á‘áŸ†á“á·á‰'], r['á€á¶á›á”ášá·á…áŸ’á†áŸá‘'], r['á…áŸ†á“á½á“'], (r['áá˜áŸ’á›áŸƒ']||0).toLocaleString()+' áŸ›']);
    doc.autoTable({ head:[['á‘áŸ†á“á·á‰','á€á¶á›á”ášá·á…áŸ’á†áŸá‘','á…áŸ†á“á½á“','áá˜áŸ’á›áŸƒ']], body, startY:30 });
    doc.save('report.pdf');
  }

  // ----- Service worker & PWA prompt -----
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; /* you can show install UI */ });
  window.addEventListener('appinstalled', ()=>{ console.log('installed'); });

  </script>
</body>
</html>
