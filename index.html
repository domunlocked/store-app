<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ការគ្រប់គ្រងហាង — Stock Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Battambang&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#007bff" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{--primary:#007bff;--bg:#f8f9fa;--card:#fff;--text:#111}
    body{font-family:'Battambang',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:12px;transition:0.2s;}
    body.dark{--bg:#0f1720;--card:#111827;--text:#e6eef8}
    .wrap{max-width:800px;margin:12px auto}
    .topbar{display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,0.06);margin-bottom:12px}
    input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #cbd5e1;font-size:15px}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer}
    button.btn-ghost{background:transparent !important;color:var(--primary) !important;border:1px solid var(--primary) !important;}
    .row{display:flex;gap:8px}
    .row>*{flex:1}
    .list-item{padding:6px;border-bottom:1px solid #e5e7eb}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button id="darkToggle" class="btn-ghost small">🌙/☀️</button>
      <button id="refreshBtn" class="btn-ghost small">🔄 Refresh</button>
    </div>

    <div id="login" class="card">
      <h2>ចូលប្រព័ន្ធ</h2>
      <input id="email" placeholder="អ៊ីមែល" />
      <input id="password" type="password" placeholder="ពាក្យសម្ងាត់" />
      <div class="row"><button onclick="login()">ចូល</button></div>
      <p id="loginStatus"></p>
    </div>

    <div id="admin" class="card" style="display:none">
      <h2>Admin</h2>
      <div class="row">
        <button onclick="logout()">ចាកចេញ</button>
        <button class="btn-ghost" onclick="toggleCatManager()">គ្រប់គ្រងប្រភេទ</button>
      </div>
      <div id="catManager" style="display:none;margin-top:10px">
        <h3>Categories</h3>
        <div class="row">
          <input id="newCategory" placeholder="ឈ្មោះប្រភេទថ្មី"/>
          <button onclick="addCategory()">បន្ថែម</button>
        </div>
        <div id="categoriesList"></div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyCL1WNujP_W_JBmFGGd7LkkVX3ZUg_3ar8",
  authDomain: "stock-store-890d2.firebaseapp.com",
  projectId: "stock-store-890d2",
  storageBucket: "stock-store-890d2.firebasestorage.app",
  messagingSenderId: "1023419430534",
  appId: "1:1023419430534:web:f13088ef89438326c18307"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();const db=firebase.firestore();

// Auth state
auth.onAuthStateChanged(u=>{
  if(u){
    if(u.email==='admin@store.com'){
      showPanel('admin');
      listenCategories();
    } else {
      showPanel('login');
    }
  } else {
    showPanel('login');
  }
});

// Auth actions
function login(){
  const e=document.getElementById('email').value.trim();
  const p=document.getElementById('password').value.trim();
  auth.signInWithEmailAndPassword(e,p).catch(err=>alert(err.message));
}
function logout(){auth.signOut();}

// Panels
function showPanel(id){
  ['login','admin'].forEach(p=>document.getElementById(p).style.display='none');
  document.getElementById(id).style.display='block';
}

// Category Manager toggle
function toggleCatManager(){
  const el=document.getElementById('catManager');
  if(!el) return;
  el.style.display=(el.style.display==='none'||el.style.display==='')?'block':'none';
}

// Firestore category live updates
function listenCategories(){
  db.collection('categories').onSnapshot(snap=>{
    document.getElementById('categoriesList').innerHTML=
      snap.docs.map(d=>`<div class='list-item'>${d.data().name}</div>`).join('');
  });
}

// Add category
function addCategory(){
  const name=document.getElementById('newCategory').value.trim();
  if(!name)return;
  db.collection('categories').add({name});
  document.getElementById('newCategory').value='';
}

// UI Toggles
document.getElementById('darkToggle').addEventListener('click',()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('darkMode',document.body.classList.contains('dark'));
});
if(localStorage.getItem('darkMode')==='true')document.body.classList.add('dark');

document.getElementById('refreshBtn').addEventListener('click',()=>location.reload());
</script>
</body>
</html>