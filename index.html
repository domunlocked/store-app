<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>á€á¶ášá‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á á¶á„ (Stock Store)</title>

  <!-- Khmer font -->
  <link href="https://fonts.googleapis.com/css2?family=Battambang&display=swap" rel="stylesheet">

  <meta name="theme-color" content="#007bff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />

  <style>
    :root{
      --primary: #007bff;
      --bg: #f8f9fa;
      --card: #fff;
      --text: #111;
    }
    body{
      font-family: 'Battambang', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 12px;
      transition: background 0.2s, color 0.2s;
    }
    body.dark{
      --bg: #0f1720;
      --card: #111827;
      --text: #e6eef8;
    }
    .wrap{ max-width: 900px; margin: 10px auto; }
    .card{
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 18px rgba(2,6,23,0.06);
      margin-bottom: 12px;
    }
    h2,h3{ margin: 6px 0 12px; }
    input, select, textarea, button{
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      box-sizing: border-box;
      font-size: 15px;
    }
    button{
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
    }
    button.btn-ghost{
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    .row{ display:flex; gap:8px; }
    .row > *{ flex: 1; }
    .small { padding: 8px; font-size: 14px; display:inline-block; }
    .list-item{ display:flex; justify-content:space-between; align-items:center; padding:8px 6px; border-bottom:1px solid rgba(0,0,0,0.06); }
    .meta { color: #6b7280; font-size: 13px; }
    img.icon { width:48px; height:48px; object-fit:cover; border-radius:8px; margin-left:8px; }
    .actions button { margin-left:6px; }
    pre { white-space: pre-wrap; word-break: break-word; }
    @media (max-width:600px){
      .row { flex-direction: column; }
      .list-item { flex-direction: column; align-items:flex-start; gap:6px; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- top controls -->
    <div style="text-align:right; margin-bottom:10px;">
      <button id="darkToggle" class="small">ğŸŒ™/â˜€ï¸ Dark Mode</button>
      <span style="display:inline-block; width:8px;"></span>
      <button id="installBtn" class="small btn-ghost" style="display:none">áŠáŸ†á¡á¾á„á€á˜áŸ’á˜áœá·á’á¸</button>
    </div>

    <!-- LOGIN CARD -->
    <div id="login" class="card">
      <h2>á…á¼á›á”áŸ’ášá–áŸá“áŸ’á’</h2>
      <input id="email" placeholder="á¢áŸŠá¸á˜áŸ‚á›" autocomplete="username" />
      <input id="password" type="password" placeholder="á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹" autocomplete="current-password" />
      <div class="row">
        <button id="loginBtn" onclick="login()">á…á¼á›</button>
        <button class="btn-ghost" onclick="showHelp()">á‡áŸ†á“á½á™</button>
      </div>
      <p id="loginStatus" class="meta"></p>
      <p class="meta">** áŸá¼á˜á”á„áŸ’á€á¾áá¢áŸ’á“á€á”áŸ’ášá¾ (admin/seller) áŠáŸ„á™áŠáŸƒá“áŸ… Firebase Console â†’ Authentication â†’ Users **</p>
    </div>

    <!-- ADMIN CARD -->
    <div id="admin" class="card" style="display:none">
      <h2>á•áŸ’á‘á¶áŸ†á„á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„</h2>
      <div class="row">
        <button onclick="logout()">á…á¼á›á…áŸá‰</button>
        <button class="btn-ghost" onclick="toggleCatManager()">á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á”áŸ’ášá—áŸá‘</button>
      </div>

      <!-- Category manager -->
      <div id="catManager" style="display:none; margin-top:10px;">
        <h3>á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á”áŸ’ášá—áŸá‘</h3>
        <div class="row">
          <input id="newCategory" placeholder="áˆáŸ’á˜áŸ„áŸ‡á”áŸ’ášá—áŸá‘ááŸ’á˜á¸" />
          <button onclick="addCategory()">á”á“áŸ’ááŸ‚á˜</button>
        </div>
        <div id="categoriesList" style="margin-top:8px;"></div>
      </div>

      <!-- Item form -->
      <h3>á”á“áŸ’ááŸ‚á˜ / á€áŸ‚á‘áŸ†á“á·á‰</h3>
      <input id="itemName" placeholder="áˆáŸ’á˜áŸ„áŸ‡á‘áŸ†á“á·á‰" />
      <input id="itemSKU" placeholder="á€á¼áŠá‘áŸ†á“á·á‰ (Optional)" />
      <input id="itemPrice" type="number" placeholder="áá˜áŸ’á›áŸƒ (áŸ›)" />
      <select id="itemCategorySelect"></select>
      <input id="itemImage" type="file" accept="image/*" />
      <input id="editItemId" type="hidden" />
      <div class="row">
        <button onclick="saveItem()">ášá€áŸ’áŸá¶á‘á»á€</button>
        <button class="btn-ghost" onclick="clearItemForm()">áŸáŸ†á¢á¶á</button>
      </div>

      <h3>á”á‰áŸ’á‡á¸á‘áŸ†á“á·á‰</h3>
      <div id="items"></div>

      <h3 style="margin-top:12px">ášá”á¶á™á€á¶ášááŸá›á€áŸ‹ (Admin)</h3>
      <div class="row">
        <button onclick="loadReport('day','admin')">ááŸ’á„áŸƒá“áŸáŸ‡</button>
        <button onclick="loadReport('week','admin')">áŸá”áŸ’áŠá¶á áŸá“áŸáŸ‡</button>
        <button onclick="loadReport('month','admin')">ááŸ‚á“áŸáŸ‡</button>
        <button onclick="loadReport('all','admin')">á‘á¶áŸ†á„á¢áŸáŸ‹</button>
      </div>

      <div style="margin-top:8px;">
        <div class="row">
          <input type="date" id="startDate" />
          <input type="date" id="endDate" />
        </div>
        <div class="row">
          <button onclick="loadReport('custom','admin')">áŸáŸ’áœáŸ‚á„ášá€</button>
          <button class="btn-ghost" onclick="clearReport('admin')">á›á»á”ášá”á¶á™á€á¶ášááŸ</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button onclick="downloadExcel()">á‘á¶á‰á…áŸá‰á‡á¶ Excel</button>
          <button onclick="downloadPDF()">á‘á¶á‰á…áŸá‰á‡á¶ PDF</button>
        </div>
      </div>

      <div id="adminReport" style="margin-top:10px;"></div>
    </div>

    <!-- SELLER CARD -->
    <div id="seller" class="card" style="display:none">
      <h2>á•áŸ’á‘á¶áŸ†á„á¢áŸ’á“á€á›á€áŸ‹</h2>
      <div class="row">
        <button onclick="logout()">á…á¼á›á…áŸá‰</button>
      </div>

      <h3>á‡áŸ’ášá¾áŸá”áŸ’ášá—áŸá‘</h3>
      <select id="sellCategory" onchange="loadSellItems()"></select>

      <h3>á‡áŸ’ášá¾áŸá‘áŸ†á“á·á‰</h3>
      <div id="sellItems"></div>

      <input id="sellQty" type="number" placeholder="á…áŸ†á“á½á“á›á€áŸ‹" />
      <button onclick="confirmSell()">á›á€áŸ‹</button>

      <h3 style="margin-top:12px">ášá”á¶á™á€á¶ášááŸá›á€áŸ‹ (Seller)</h3>
      <div class="row">
        <button onclick="loadReport('day','seller')">ááŸ’á„áŸƒá“áŸáŸ‡</button>
        <button onclick="loadReport('week','seller')">áŸá”áŸ’áŠá¶á áŸá“áŸáŸ‡</button>
        <button onclick="loadReport('month','seller')">ááŸ‚á“áŸáŸ‡</button>
        <button onclick="loadReport('all','seller')">á‘á¶áŸ†á„á¢áŸáŸ‹</button>
      </div>

      <div style="margin-top:8px">
        <div class="row">
          <input type="date" id="startDateSeller" />
          <input type="date" id="endDateSeller" />
        </div>
        <div class="row">
          <button onclick="loadReport('custom','seller')">áŸáŸ’áœáŸ‚á„ášá€</button>
          <button class="btn-ghost" onclick="clearReport('seller')">á›á»á”ášá”á¶á™á€á¶ášááŸ</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button onclick="downloadExcel()">Excel</button>
          <button onclick="downloadPDF()">PDF</button>
        </div>
      </div>

      <div id="report" style="margin-top:10px;"></div>
    </div>

  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- XLSX & jsPDF for export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
/* ============================
   FIREBASE CONFIG (your keys)
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyCL1WNujP_W_JBmFGGd7LkkVX3ZUg_3ar8",
  authDomain: "stock-store-890d2.firebaseapp.com",
  projectId: "stock-store-890d2",
  storageBucket: "stock-store-890d2.firebasestorage.app",
  messagingSenderId: "1023419430534",
  appId: "1:1023419430534:web:f13088ef89438326c18307"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const $ = id => document.getElementById(id);

/* ============================
   STATE
   ============================ */
let lastReportData = [];     // data exported
let lastReportRange = null;  // {start:Date, end:Date} used by clearReport

/* ============================
   UI helpers
   ============================ */
function showPanel(id){
  ['login','admin','seller'].forEach(p => document.getElementById(p).style.display = 'none');
  document.getElementById(id).style.display = 'block';
}

/* ============================
   AUTH / LOGIN
   ============================ */
auth.onAuthStateChanged(user => {
  if(user){
    // show admin for admin@store.com
    if(user.email === 'admin@store.com'){
      showPanel('admin');
      loadItems();
      loadCategories();
    } else {
      showPanel('seller');
      loadCategories();
    }
  } else {
    showPanel('login');
  }
});

async function login(){
  const email = $('email').value.trim();
  const pass = $('password').value.trim();
  if(!email || !pass){
    alert('áŸá¼á˜á”á‰áŸ’á…á¼á›á¢áŸŠá¸á˜áŸ‚á› á“á·á„á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹');
    return;
  }
  $('loginBtn').disabled = true;
  $('loginStatus').innerText = 'á€áŸ†á–á»á„á…á¼á›...';
  try{
    // keep local persistence for "remember me"
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
    // onAuthStateChanged will handle UI
  } catch(e) {
    alert('á…á¼á›á”ášá¶á‡áŸá™: ' + e.message);
  } finally {
    $('loginBtn').disabled = false;
    $('loginStatus').innerText = '';
  }
}

function logout(){
  auth.signOut();
}

/* ============================
   CATEGORIES
   ============================ */
async function addCategory(){
  const name = $('newCategory').value.trim();
  if(!name) { alert('á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á”áŸ’ášá—áŸá‘'); return; }
  await db.collection('categories').add({ name });
  $('newCategory').value = '';
  await loadCategories();
}

async function loadCategories(){
  // Load categories from 'categories' collection
  const snap = await db.collection('categories').get();
  let cats = snap.docs.map(d => ({ id: d.id, name: d.data().name }));

  // Also include categories that exist only on items
  const itemsSnap = await db.collection('items').get();
  itemsSnap.docs.forEach(d => {
    const c = d.data().category;
    if(c && !cats.find(x => x.name === c)) cats.push({ id: null, name: c});
  });

  // populate sellCategory and itemCategorySelect
  $('sellCategory').innerHTML = cats.map(c => `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('') || '<option value="">á‘á‘áŸ</option>';
  $('itemCategorySelect').innerHTML = '<option value="">-- á‡áŸ’ášá¾áŸá”áŸ’ášá—áŸá‘ --</option>' + cats.map(c => `<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');

  // render category list (allow edit/delete if id present)
  $('categoriesList').innerHTML = cats.map(c => {
    const idAttr = c.id ? `data-id="${c.id}"` : '';
    return `<div class="list-item"><div>${escapeHtml(c.name)}</div><div>
      ${c.id ? `<button onclick="editCategory('${c.id}','${escapeJs(c.name)}')">á€áŸ‚</button>` : `<button class="btn-ghost" onclick="alert('Category created from items; edit items instead')">á€áŸ‚</button>`}
      ${c.id ? `<button onclick="deleteCategory('${c.id}')">á›á»á”</button>` : ''}
    </div></div>`;
  }).join('');
}

function editCategory(id, name){
  const newName = prompt('á€áŸ‚áˆáŸ’á˜áŸ„áŸ‡á”áŸ’ášá—áŸá‘:', name);
  if(!newName) return;
  db.collection('categories').doc(id).update({ name: newName }).then(loadCategories);
}

async function deleteCategory(id){
  if(!confirm('áá¾á¢áŸ’á“á€á…á„áŸ‹á›á»á”á”áŸ’ášá—áŸá‘á“áŸáŸ‡á˜áŸ‚á“á‘áŸ?')) return;
  await db.collection('categories').doc(id).delete();
  await loadCategories();
}

/* ============================
   ITEMS (Admin)
   ============================ */
async function saveItem(){
  const id = $('editItemId').value.trim();
  const name = $('itemName').value.trim();
  const sku = $('itemSKU') ? $('itemSKU').value.trim() : '';
  const price = parseFloat($('itemPrice').value) || 0;
  const category = $('itemCategorySelect').value || '';
  const file = $('itemImage').files[0];

  if(!name){
    alert('á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á‘áŸ†á“á·á‰');
    return;
  }

  let imageUrl = '';
  if(file){
    // upload to storage
    const ref = storage.ref('items/' + Date.now() + '-' + file.name);
    const uploadTask = await ref.put(file);
    imageUrl = await ref.getDownloadURL();
  }

  if(id){
    const updateData = { name, sku, price, category };
    if(imageUrl) updateData.imageUrl = imageUrl;
    await db.collection('items').doc(id).update(updateData);
    alert('á”á¶á“á€áŸ‚á‘áŸ†á“á·á‰');
  } else {
    await db.collection('items').add({ name, sku, price, category, imageUrl });
    alert('á”á¶á“á”á“áŸ’ááŸ‚á˜á‘áŸ†á“á·á‰');
  }

  clearItemForm();
  await loadItems();
  await loadCategories();
}

function clearItemForm(){
  $('editItemId').value = '';
  $('itemName').value = '';
  if($('itemSKU')) $('itemSKU').value = '';
  $('itemPrice').value = '';
  $('itemCategorySelect').value = '';
  $('itemImage').value = '';
}

async function loadItems(){
  const snap = await db.collection('items').get();
  if(snap.empty){ $('items').innerHTML = '<div>á‚áŸ’á˜á¶á“á‘áŸ†á“á·á‰</div>'; return; }
  const html = snap.docs.map(d => {
    const it = d.data();
    const img = it.imageUrl ? `<img class="icon" src="${escapeHtml(it.imageUrl)}" />` : '';
    return `<div class="list-item">
      <div style="display:flex;align-items:center;">
        ${img}<div style="margin-left:8px;"><b>${escapeHtml(it.name)}</b><div class="meta">${escapeHtml(it.category||'')}</div><div class="meta">${Number(it.price).toLocaleString()} áŸ›</div></div>
      </div>
      <div class="actions">
        <button onclick="startEdit('${d.id}')">á€áŸ‚</button>
        <button onclick="deleteItem('${d.id}')">á›á»á”</button>
      </div>
    </div>`;
  }).join('');
  $('items').innerHTML = html;
}

async function startEdit(id){
  const doc = await db.collection('items').doc(id).get();
  if(!doc.exists) return alert('Item not found');
  const it = doc.data();
  $('editItemId').value = id;
  $('itemName').value = it.name || '';
  if($('itemSKU')) $('itemSKU').value = it.sku || '';
  $('itemPrice').value = it.price || '';
  $('itemCategorySelect').value = it.category || '';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function deleteItem(id){
  if(!confirm('áá¾á¢áŸ’á“á€á…á„áŸ‹á›á»á”á‘áŸ†á“á·á‰á“áŸáŸ‡á˜áŸ‚á“á‘áŸ?')) return;
  await db.collection('items').doc(id).delete();
  await loadItems();
  await loadCategories();
}

/* ============================
   SELLER: choose category -> items -> sell qty
   ============================ */
async function loadSellItems(){
  const cat = $('sellCategory').value;
  if(!cat){ $('sellItems').innerHTML = '<div>áŸá¼á˜á‡áŸ’ášá¾áŸá”áŸ’ášá—áŸá‘</div>'; return; }
  const snap = await db.collection('items').where('category','==',cat).get();
  if(snap.empty){ $('sellItems').innerHTML = '<div>á‚áŸ’á˜á¶á“á‘áŸ†á“á·á‰</div>'; return; }
  const options = snap.docs.map(d => {
    const it = d.data();
    return `<option value="${d.id}">${escapeHtml(it.name)} â€” ${Number(it.price).toLocaleString()} áŸ›</option>`;
  }).join('');
  $('sellItems').innerHTML = `<select id="sellItem">${options}</select>`;
}

async function confirmSell(){
  const sel = $('sellItem');
  if(!sel){ alert('áŸá¼á˜á‡áŸ’ášá¾áŸá‘áŸ†á“á·á‰á˜á»á“'); return; }
  const itemId = sel.value;
  const qty = parseInt($('sellQty').value) || 1;
  if(qty <= 0){ alert('á…áŸ†á“á½á“ááŸ’ášá¼áœá”á¾á€á–á¸ 1'); return; }
  const itemDoc = await db.collection('items').doc(itemId).get();
  if(!itemDoc.exists) { alert('á‘áŸ†á“á·á‰á˜á·á“á˜á¶á“'); return; }
  const item = itemDoc.data();
  await db.collection('sales').add({
    itemId,
    qty,
    total: (item.price || 0) * qty,
    timestamp: firebase.firestore.Timestamp.fromDate(new Date())
  });
  alert('á›á€áŸ‹á”á¶á“á‡áŸ„á‚á‡áŸá™!');
}

/* ============================
   REPORTS: grouped + subtotals (today/week/month)
   ============================ */
function toKhmerNumber(n){
  try { return Number(n).toLocaleString('km-KH'); } catch(e){ return n; }
}

async function loadReport(period, from='seller'){
  // compute start/end dates
  let start = new Date();
  let end = new Date();
  if(period === 'day'){ start.setHours(0,0,0,0); }
  if(period === 'week'){ start.setDate(start.getDate() - 7); }
  if(period === 'month'){ start.setMonth(start.getMonth() - 1); }
  if(period === 'all'){ start = new Date(0); }
  if(period === 'custom'){
    const sVal = (from === 'seller') ? $('startDateSeller').value : $('startDate').value;
    const eVal = (from === 'seller') ? $('endDateSeller').value : $('endDate').value;
    start = sVal ? new Date(sVal) : new Date(0);
    end = eVal ? new Date(eVal) : new Date();
    end.setHours(23,59,59,999);
  }

  // store range for clearReport
  lastReportRange = { start: new Date(start), end: new Date(end) };

  // Build query using Timestamp bounds
  let q = db.collection('sales').where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(start));
  if(period === 'custom'){
    q = q.where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(end));
  }
  // orderBy timestamp requires the field used in where() - good
  q = q.orderBy('timestamp', 'desc');

  const snap = await q.get();

  // compute subtotals relative to now
  const now = new Date();
  const startToday = new Date(); startToday.setHours(0,0,0,0);
  const startWeek = new Date(); startWeek.setDate(startWeek.getDate() - 7);
  const startMonth = new Date(); startMonth.setMonth(startMonth.getMonth() - 1);

  let todayTotal = 0, weekTotal = 0, monthTotal = 0;
  let total = 0;
  let grouped = {}; // { name: { qty, total, sales:[{date,qty,total}] } }

  // iterate sales
  for(const doc of snap.docs){
    const sale = doc.data();
    const ts = sale.timestamp && sale.timestamp.toDate ? sale.timestamp.toDate() : new Date();
    if(ts >= startToday) todayTotal += sale.total || 0;
    if(ts >= startWeek) weekTotal += sale.total || 0;
    if(ts >= startMonth) monthTotal += sale.total || 0;

    total += sale.total || 0;

    let itemName = 'á˜á·á“áŸáŸ’á‚á¶á›áŸ‹';
    if(sale.itemId){
      const itDoc = await db.collection('items').doc(sale.itemId).get();
      if(itDoc.exists) itemName = itDoc.data().name;
    }
    if(!grouped[itemName]) grouped[itemName] = { qty: 0, total: 0, sales: [] };
    grouped[itemName].qty += sale.qty || 0;
    grouped[itemName].total += sale.total || 0;
    grouped[itemName].sales.push({
      date: ts.toLocaleString('km-KH'),
      qty: sale.qty || 0,
      total: sale.total || 0
    });
  }

  // build html and lastReportData for export
  let html = '';
  lastReportData = [];

  // For each grouped item
  Object.keys(grouped).forEach(name => {
    const g = grouped[name];
    html += `<div class="card"><b>${escapeHtml(name)}</b><div class="meta">á…áŸ†á“á½á“: ${g.qty} â€¢ áá˜áŸ’á›áŸƒáŸášá»á”: ${g.total.toLocaleString()} áŸ›</div>`;
    g.sales.forEach(s => {
      html += `<div style="margin-left:12px">ğŸ—“ ${escapeHtml(s.date)} â€¢ á…áŸ†á“á½á“: ${s.qty} â€¢ ${Number(s.total).toLocaleString()} áŸ›</div>`;
      lastReportData.push({ á‘áŸ†á“á·á‰: name, á€á¶á›á”ášá·á…áŸ’á†áŸá‘: s.date, á…áŸ†á“á½á“: s.qty, áá˜áŸ’á›áŸƒ: s.total });
    });
    html += `</div>`;
  });

  // subtotals and grand total
  html += `<div style="font-weight:bold;margin-top:8px">ğŸ“… ááŸ’á„áŸƒá“áŸáŸ‡: ${toKhmerNumber(todayTotal)} áŸ›</div>`;
  html += `<div style="font-weight:bold">ğŸ“… áŸá”áŸ’áŠá¶á áŸá“áŸáŸ‡: ${toKhmerNumber(weekTotal)} áŸ›</div>`;
  html += `<div style="font-weight:bold">ğŸ“… ááŸ‚á“áŸáŸ‡: ${toKhmerNumber(monthTotal)} áŸ›</div>`;
  html += `<div style="font-weight:bold;margin-top:6px">áŸášá»á”: ${toKhmerNumber(total)} áŸ›</div>`;

  lastReportData.push({ á‘áŸ†á“á·á‰: 'áŸášá»á”', á€á¶á›á”ášá·á…áŸ’á†áŸá‘: '', á…áŸ†á“á½á“: '', áá˜áŸ’á›áŸƒ: total });

  // display
  if(from === 'seller') $('report').innerHTML = html;
  else $('adminReport').innerHTML = html;
}

/* ============================
   CLEAR REPORT -> delete sales in range (or all)
   ============================ */
async function clearReport(from){
  if(!confirm('áá¾á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á›á»á”á‘á·á“áŸ’á“á“áŸá™ášá”á¶á™á€á¶ášááŸ? á“áŸáŸ‡á˜á·á“á¢á¶á…áŠá€áœá·á‰á”á¶á“á‘áŸáŸ”')) return;

  try {
    if(lastReportRange && lastReportRange.start && lastReportRange.end){
      // delete only sales within range
      const q = db.collection('sales')
        .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(new Date(lastReportRange.start)))
        .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(new Date(lastReportRange.end)));
      const snap = await q.get();
      if(snap.empty){
        alert('á˜á·á“á˜á¶á“á›á€áŸ‹á€áŸ’á“á»á„á‡á½ášá“áŸ„áŸ‡á‘áŸáŸ”');
        return;
      }
      const batch = db.batch();
      snap.forEach(d => batch.delete(d.ref));
      await batch.commit();
      lastReportData = [];
      if(from === 'seller') $('report').innerHTML = 'á‘á·á“áŸ’á“á“áŸá™á”á¶á“á›á»á”á á¾á™ âœ…';
      else $('adminReport').innerHTML = 'á‘á·á“áŸ’á“á“áŸá™á”á¶á“á›á»á”á á¾á™ âœ…';
      alert('á”á¶á“á›á»á”ášá”á¶á™á€á¶ášááŸá€áŸ’á“á»á„á‡á½ášáŠáŸ‚á›á”á¶á“á‡áŸ’ášá¾áŸáŸ”');
      return;
    }

    // if no range, delete all sales
    if(!confirm('á˜á·á“á˜á¶á“á‡á½ášáŠáŸ‚á›á”á¶á“á‘á¶á‰á™á€ â€” á“áŸáŸ‡á“á¹á„á›á»á”á›á€áŸ‹á‘á¶áŸ†á„á¢áŸáŸ‹! áá¾á”á“áŸ’á?')) return;
    const allSnap = await db.collection('sales').get();
    if(allSnap.empty){
      alert('á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŠá¾á˜áŸ’á”á¸á›á»á”áŸ”');
      return;
    }
    const batchAll = db.batch();
    allSnap.forEach(d => batchAll.delete(d.ref));
    await batchAll.commit();
    lastReportData = [];
    if(from === 'seller') $('report').innerHTML = 'á‘á·á“áŸ’á“á“áŸá™á”á¶á“á›á»á”á á¾á™ âœ…';
    else $('adminReport').innerHTML = 'á‘á·á“áŸ’á“á“áŸá™á”á¶á“á›á»á”á á¾á™ âœ…';
    alert('á”á¶á“á›á»á”á‘á·á“áŸ’á“á“áŸá™á›á€áŸ‹á‘á¶áŸ†á„á¢áŸáŸ‹áŸ”');

  } catch(e){
    alert('á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá›á»á”: ' + e.message);
  }
}

/* ============================
   EXPORTS: Excel & PDF
   ============================ */
function downloadExcel(){
  if(!lastReportData.length) return alert('á‚áŸ’á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹á‘á¶á‰á…áŸá‰');
  const ws = XLSX.utils.json_to_sheet(lastReportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ášá”á¶á™á€á¶ášááŸ');
  XLSX.writeFile(wb, 'report.xlsx');
}

function downloadPDF(){
  if(!lastReportData.length) return alert('á‚áŸ’á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹á‘á¶á‰á…áŸá‰');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text('ášá”á¶á™á€á¶ášááŸá›á€áŸ‹', 14, 20);
  const body = lastReportData.map(r => [ r['á‘áŸ†á“á·á‰'], r['á€á¶á›á”ášá·á…áŸ’á†áŸá‘'], r['á…áŸ†á“á½á“'], (r['áá˜áŸ’á›áŸƒ']||0).toLocaleString() + ' áŸ›' ]);
  doc.autoTable({ head: [['á‘áŸ†á“á·á‰','á€á¶á›á”ášá·á…áŸ’á†áŸá‘','á…áŸ†á“á½á“','áá˜áŸ’á›áŸƒ']], body, startY: 30 });
  doc.save('report.pdf');
}

/* ============================
   PWA / Service Worker / Install prompt
   ============================ */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log('SW registered')).catch(()=>console.log('SW failed'));
}

let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $('installBtn').style.display = 'inline-block';
});

$('installBtn').addEventListener('click', async () => {
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  if(choice.outcome === 'accepted') $('installBtn').style.display = 'none';
  deferredPrompt = null;
});

/* ============================
   UTILITIES
   ============================ */
function escapeHtml(s){
  if(!s && s !== 0) return '';
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'", '&#39;');
}
function escapeJs(s){
  if(!s && s !== 0) return '';
  return String(s).replace(/'/g, "\\'").replace(/"/g, '\\"');
}

/* ============================
   INITIAL LOADS
   ============================ */
document.getElementById('darkToggle').addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('darkMode', document.body.classList.contains('dark'));
});
if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark');

// initial populate categories & items for UI goodness
// (only visible after login via auth.onAuthStateChanged)
async function initAfterLogin(){
  await loadCategories();
  await loadItems();
}
</script>
</body>
</html>
